<!DOCTYPE html>

<html>
    <head>
        <script src='https://cdn.firebase.com/js/client/1.1.1/firebase.js'></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
        <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
        <meta charset="utf-8">
        <title>Simple map</title>
        <style>
            html, body, #map-canvas {
                height: 100%;
                margin: 0px;
                padding: 0px;
		background-color: #F5F5F5;
            }
            div.map-popup {
                overflow: auto;
                overflow-x: hidden;
                overflow-y: auto;
            }
        </style>
        <script src="https://maps.googleapis.com/maps/api/js?v=3.exp"></script>
    </head>
    <body>
        <div id="map-canvas"></div>
        <script>
            var markerList = [];
            var map;
            function initialize() {
					
                var lat=78;
                var longi=37.5;
                var myFirebaseRef = new Firebase("https://e-pulse.firebaseio.com/");
                var myLatlng = new google.maps.LatLng(lat,longi);
                var mapOptions = {
                    zoom: 4,
                    center: myLatlng
                };
                map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);
                myFirebaseRef.on('child_added', function(snapshot) {
                    lat = snapshot.child("Lat").val();
                    longi = snapshot.child("Long").val();
                    keywords = snapshot.child("Keywords").val();
                    timee = snapshot.child("Timestamp").val();
                    var temppos = new google.maps.LatLng(lat,longi);
                    var image = 'event.png';
                    var tempmarker = new google.maps.Marker( {
                        position: temppos,
                        map: map,
                        title: "event",
                        icon: image,
                        zIndex: timee
                        });
                    
                    var tempinfo = new google.maps.InfoWindow({
                        content: keywords
                    });
                    google.maps.event.addListener(tempmarker, 'click', function() {
                        tempinfo.open(map,tempmarker)
                    });
                    markerList.push(tempmarker);                    
                    eventToTweetArray(snapshot,map);
                });
            }
            var interval = setInterval(function (){updater(map)},10000);
            function eventToTweetArray(snap, map) {
                snap.forEach(function(tweet) {
                    if(tweet.hasChildren()) {
                        lat = tweet.child("Lat").val();
                        longi = tweet.child("Long").val();
                        keywords = tweet.child("Data").val();
                        timee = tweet.child("Timestamp").val();
                        var temppos = new google.maps.LatLng(lat,longi);
                        var image = 'tweet.png';
                        var tempmarker = new google.maps.Marker( {
                            position: temppos,
                            map: map,
                            title: "tweet",
                            icon: image,
                            zIndex: timee
                            });
                        console.log(temppos);
                        var wrapper = document.createElement("div");
                        wrapper.innerHTML = keywords;
                        wrapper.className = "map-popup";
                        wrapper.style.height="20em";
                        var tempinfo = new google.maps.InfoWindow({
                            content: wrapper,//keywords,
                        });
 
			google.maps.event.addListener(tempinfo, 'domready', function () {
                                ! function (d, s, id) {
                                    console.log(d.getElementsByTagName(s));
                                    var js, fjs = d.getElementsByTagName(s)[0];
                                    if (!d.getElementById(id)) {
                                        js = d.createElement(s);
                                        js.id = id;
                                        js.src = "//platform.twitter.com/widgets.js";
                                        fjs.parentNode.insertBefore(js, fjs);
                                    }
                                }(document, "script", "twitter-wjs");
                        });  
                        google.maps.event.addListener(tempmarker, 'click', function() {
                            tempinfo.open(map,tempmarker)
                        });
                        markerList.push(tempmarker);
                    }
                });
            } 
            function updater(map) {
                var time = new Date().getTime()/1000; 
                var arrayLength = markerList.length;
                for(var i = 0;i < arrayLength;i++) {
                    if(time < markerList[i].zIndex || time > markerList[i].zIndex + 7200) {
                        console.log("System time: "+time);
                        console.log("Marker time: "+markerList[i].zIndex);
                        if(markerList[i].getMap() !== null){
                            markerList[i].setMap(null);
                        }
                    } else{
                        if(!markerList[i].getMap()){
                            markerList[i].setMap(map);
                        }
                    }
                }
            }
            google.maps.event.addDomListener(window, 'load', initialize);
        </script>
    </body>
</html>

